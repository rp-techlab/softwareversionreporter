package org.zaproxy.addon.softwareversionreporter;

import com.fasterxml.jackson.databind.JsonNode;
import java.util.ArrayList;
import java.util.List;
import org.zaproxy.addon.softwareversionreporter.model.EnrichmentResult;

public final class VulnerabilityMappers {
   private VulnerabilityMappers() {
   }

   public static EnrichmentResult.VulnerabilityInfo mapNvdCve(JsonNode cve) {
      EnrichmentResult.VulnerabilityInfo v = new EnrichmentResult.VulnerabilityInfo();
      String id = cve.path("id").asText("");
      v.setCveId(id);
      if (cve.path("descriptions").isArray()) {
         for(JsonNode d : cve.path("descriptions")) {
            if ("en".equalsIgnoreCase(d.path("lang").asText())) {
               v.setShortDescription(d.path("value").asText(""));
               break;
            }
         }
      }

      double score = (double)0.0F;
      JsonNode m31 = cve.path("metrics").path("cvssMetricV31");
      JsonNode m30 = cve.path("metrics").path("cvssMetricV30");
      JsonNode m2 = cve.path("metrics").path("cvssMetricV2");
      if (m31.isArray() && m31.size() > 0) {
         score = m31.get(0).path("cvssData").path("baseScore").asDouble((double)0.0F);
      } else if (m30.isArray() && m30.size() > 0) {
         score = m30.get(0).path("cvssData").path("baseScore").asDouble((double)0.0F);
      } else if (m2.isArray() && m2.size() > 0) {
         score = m2.get(0).path("cvssData").path("baseScore").asDouble((double)0.0F);
      }

      v.setCvssScore(score);
      v.setLink("https://nvd.nist.gov/vuln/detail/" + id);
      v.setTitle(id.isEmpty() ? "Vulnerability" : id);
      return v;
   }

   public static EnrichmentResult.VulnerabilityInfo mapVulnersItem(JsonNode item) {
      JsonNode src = item.has("_source") ? item.path("_source") : item;
      EnrichmentResult.VulnerabilityInfo v = new EnrichmentResult.VulnerabilityInfo();
      String title = src.path("title").asText("");
      String desc = src.path("description").asText(src.path("summary").asText(src.path("snippet").asText("")));
      String link = src.path("href").asText("");
      String cve = "NO-CVE";
      if (src.path("cvelist").isArray() && src.path("cvelist").size() > 0) {
         cve = src.path("cvelist").get(0).asText("NO-CVE");
      } else if (src.has("id") && src.path("id").asText("").startsWith("CVE-")) {
         cve = src.path("id").asText("NO-CVE");
      }

      double score = (double)0.0F;
      if (src.has("cvss")) {
         JsonNode cvssNode = src.path("cvss");
         score = cvssNode.has("score") ? cvssNode.path("score").asDouble((double)0.0F) : cvssNode.asDouble((double)0.0F);
      }

      v.setCveId(cve);
      v.setTitle(title.isEmpty() ? cve : title);
      v.setShortDescription(desc);
      v.setLink(link);
      v.setCvssScore(score);
      return v;
   }

   public static EnrichmentResult.VulnerabilityInfo mapVuldbEntry(JsonNode entry) {
      EnrichmentResult.VulnerabilityInfo v = new EnrichmentResult.VulnerabilityInfo();
      String id = entry.path("entry").path("id").asText("");
      String title = entry.path("entry").path("title").asText("");
      String cve = entry.path("source").path("cve").path("id").asText("");
      String link = id.isEmpty() ? "" : "https://vuldb.com/?id." + id;
      String riskName = entry.path("vulnerability").path("risk").path("name").asText("").toLowerCase();
      int riskValue = entry.path("vulnerability").path("risk").path("value").asInt(-1);
      double score = (double)0.0F;
      if (riskValue >= 0) {
         switch (riskValue) {
            case 1 -> score = (double)3.0F;
            case 2 -> score = (double)6.0F;
            case 3 -> score = (double)8.5F;
            default -> score = (double)1.0F;
         }
      } else {
         switch (riskName) {
            case "low" -> score = (double)3.0F;
            case "medium" -> score = (double)6.0F;
            case "high" -> score = (double)8.5F;
            case "critical" -> score = (double)9.5F;
            default -> score = (double)1.0F;
         }
      }

      v.setCveId(!cve.isEmpty() ? cve : (!id.isEmpty() ? "VULDB-" + id : "VULDB"));
      v.setTitle(title.isEmpty() ? v.getCveId() : title);
      v.setShortDescription(title);
      v.setDescription(title);
      v.setLink(link);
      v.setCvssScore(score);
      v.setSeverity(riskName);
      if (entry.path("references").isArray()) {
         List<String> refs = new ArrayList();

         for(JsonNode r : entry.path("references")) {
            if (r.isTextual()) {
               refs.add(r.asText());
            }
         }

         v.setReferences(refs);
      }

      return v;
   }
}
