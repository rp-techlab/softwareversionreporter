package org.zaproxy.addon.softwareversionreporter;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.zaproxy.addon.softwareversionreporter.api.NVDClient;
import org.zaproxy.addon.softwareversionreporter.api.VulDBClient;
import org.zaproxy.addon.softwareversionreporter.api.VulnersClient;
import org.zaproxy.addon.softwareversionreporter.model.EnrichmentResult;
import org.zaproxy.addon.softwareversionreporter.util.CpeUtil;

public class VulnerabilityEnrichmentService {
   private static final Logger LOGGER = LogManager.getLogger(VulnerabilityEnrichmentService.class);
   private final SoftwareVersionReporterParam param;

   public VulnerabilityEnrichmentService(SoftwareVersionReporterParam param) {
      this.param = param;
   }

   public EnrichmentResult query(String software, String version, String vendor, String product) {
      if (!this.param.isEnrichmentEnabled()) {
         LOGGER.debug("SVR: enrichment disabled in options");
         return null;
      } else {
         String provider = this.param.getApiProvider() != null ? this.param.getApiProvider() : "NVD";
         LOGGER.info("SVR enrichment: SELECTED_PROVIDER={} software={} version={} vendor={} product={}", provider, software, version, vendor, product);

         try {
            switch (provider.toUpperCase()) {
               case "NVD":
                  return this.queryNVD(software, version, vendor, product);
               case "VULNERS":
                  return this.queryVulners(software, version, vendor, product);
               case "VULDB":
                  return this.queryVulDB(software, version, vendor, product);
               default:
                  LOGGER.warn("SVR: Unknown provider '{}', defaulting to NVD", provider);
                  return this.queryNVD(software, version, vendor, product);
            }
         } catch (Exception e) {
            LOGGER.error("SVR: {} query failed for {} {}: {}", provider, software, version, e.getMessage());
            return null;
         }
      }
   }

   private EnrichmentResult queryNVD(String software, String version, String vendor, String product) {
      LOGGER.info("SVR: ====> ROUTING TO NVD (as selected in options)");
      String apiKey = this.param.getNvdApiKey();
      if (apiKey != null && !apiKey.isEmpty()) {
         LOGGER.info("SVR: NVD running WITH API key (50 requests per 30 seconds)");
      } else {
         LOGGER.info("SVR: NVD running WITHOUT API key (rate limited to 5 requests per 30 seconds)");
      }

      try {
         String cpe = CpeUtil.build(vendor, product, version);
         LOGGER.info("SVR: NVD query cpe={}", cpe);
         NVDClient client = new NVDClient();
         return client.queryByCpe(software, version, cpe);
      } catch (Exception e) {
         LOGGER.error("SVR: NVD query error: {}", e.getMessage());
         return null;
      }
   }

   private EnrichmentResult queryVulners(String software, String version, String vendor, String product) {
      LOGGER.info("SVR: ====> ROUTING TO VULNERS (as selected in options)");
      String apiKey = this.param.getVulnersApiKey();
      if (apiKey != null && !apiKey.isEmpty()) {
         try {
            LOGGER.info("SVR: Vulners query software={} version={} vendor={} product={}", software, version, vendor, product);
            VulnersClient client = new VulnersClient(apiKey);
            return client.queryByProduct(software, version, vendor, product);
         } catch (Exception e) {
            LOGGER.error("SVR: Vulners query error: {}", e.getMessage());
            return null;
         }
      } else {
         LOGGER.warn("SVR: Vulners selected but NO API KEY configured! Register free at vulners.com");
         return null;
      }
   }

   private EnrichmentResult queryVulDB(String software, String version, String vendor, String product) {
      LOGGER.info("SVR: ====> ROUTING TO VULDB (as selected in options)");
      String apiKey = this.param.getVuldbApiKey();
      if (apiKey != null && !apiKey.isEmpty()) {
         try {
            LOGGER.info("SVR: VulDB query vendor={} product={} version={}", vendor, product, version);
            VulDBClient client = new VulDBClient(apiKey);
            return client.query(software, version, vendor, product);
         } catch (Exception e) {
            LOGGER.error("SVR: VulDB query error: {}", e.getMessage());
            return null;
         }
      } else {
         LOGGER.warn("SVR: VulDB selected but NO API KEY configured! Get key from vuldb.com");
         return null;
      }
   }
}
